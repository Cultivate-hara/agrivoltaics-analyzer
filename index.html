<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å–¶è¾²å‹å¤ªé™½å…‰ç™ºé›» é®å…‰ç‡åˆ†æãƒ„ãƒ¼ãƒ«</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        #map { height: 400px; width: 100%; position: relative; }
        .map-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7); display: flex;
            align-items: center; justify-content: center; z-index: 1000;
        }
        .api-key-form {
            background: white; padding: 30px; border-radius: 10px;
            max-width: 500px; width: 90%;
        }
        .map-controls {
            background-color: white;
            border: 2px solid #ddd;
            border-radius: 3px;
            box-shadow: 0 2px 6px rgba(0,0,0,.3);
            margin: 10px;
            padding: 10px;
            text-align: center;
        }
        .controls-button {
            background-color: #4CAF50;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 2px;
        }
        .controls-button:hover {
            background-color: #45a049;
        }
        .controls-button.active {
            background-color: #2196F3;
        }
        .area-info {
            background-color: white;
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-top: 10px;
        }
        #searchBox {
            margin: 10px;
            padding: 10px 15px;
            font-size: 14px;
            width: 300px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            background-color: white;
        }
        #searchBox:focus {
            border-color: #4285f4;
            outline: none;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-green-50 to-blue-50 min-h-screen">
    <div class="max-w-7xl mx-auto p-6">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">
                å–¶è¾²å‹å¤ªé™½å…‰ç™ºé›» é®å…‰ç‡åˆ†æãƒ„ãƒ¼ãƒ«
            </h1>
            <p class="text-gray-600">Google Mapsã§è¾²åœ°ã‚’é¸æŠã—ã€å¤ªé™½å…‰ãƒ‘ãƒãƒ«é…ç½®ã¨é®å…‰ç‡ã‚’åˆ†æã—ã¾ã™</p>
        </div>

        <!-- Google Mapsçµ±åˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <h2 class="text-xl font-bold mb-4">è¾²åœ°é¸æŠï¼ˆGoogle Mapsï¼‰</h2>
            <div class="mb-3">
                <input id="searchBox" type="text" placeholder="ä½æ‰€ã‚„åœ°åã‚’æ¤œç´¢ï¼ˆä¾‹ï¼šâ—‹â—‹å¸‚â–³â–³ç”ºã€â–¡â–¡è¾²åœ’ï¼‰" 
                    class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                    style="display: none;">
            </div>
            <div id="map"></div>
            <div class="area-info" id="areaInfo" style="display: none;">
                <p>é¸æŠã•ã‚ŒãŸè¾²åœ°é¢ç©: <span id="selectedArea" class="font-bold">0</span> mÂ²</p>
                <p>å®Ÿæ¸¬ã‚µã‚¤ã‚º: å¹…ï¼ˆæ±è¥¿ï¼‰ <span id="actualWidth" class="font-bold">0</span> m Ã— é•·ã•ï¼ˆå—åŒ—ï¼‰ <span id="actualLength" class="font-bold">0</span> m</p>
                <div class="mt-2 p-2 bg-yellow-50 rounded">
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        è¾²åœ°ã‹ã‚‰ã®é›¢éš”è·é›¢ (m)
                    </label>
                    <input type="number" id="fieldMargin" value="1" min="0" step="0.5" 
                        class="w-32 p-1 border border-gray-300 rounded"
                        onchange="updateFieldDimensions()">
                    <span class="text-xs text-gray-600 ml-2">â€»å››æ–¹ã‹ã‚‰åŒã˜è·é›¢ã‚’é›¢ã—ã¾ã™</span>
                </div>
            </div>
            <div class="area-info" id="apiKeyWarning" style="display: none;">
                <p class="text-sm text-yellow-800">
                    <strong>é‡è¦ï¼š</strong>APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚
                    <button onclick="showApiKeyForm()" class="underline text-yellow-900">è¨­å®šã™ã‚‹</button>
                </p>
            </div>
            <div class="map-overlay" id="apiKeyOverlay" style="display: none;">
                <div class="api-key-form">
                    <h3 class="text-xl font-bold mb-4">Google Maps APIã‚­ãƒ¼ã®è¨­å®š</h3>
                    <p class="text-gray-600 mb-4">
                        ã“ã®ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ã€Google Maps APIã‚­ãƒ¼ãŒå¿…è¦ã§ã™ã€‚
                    </p>
                    <div class="bg-blue-50 p-4 rounded mb-4">
                        <h4 class="font-bold text-blue-800 mb-2">APIã‚­ãƒ¼ã®å–å¾—æ–¹æ³•ï¼š</h4>
                        <ol class="list-decimal list-inside text-sm text-blue-700 space-y-1">
                            <li><a href="https://console.cloud.google.com/" target="_blank" class="underline">Google Cloud Console</a>ã«ã‚¢ã‚¯ã‚»ã‚¹</li>
                            <li>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ</li>
                            <li>ä»¥ä¸‹ã®APIã‚’æœ‰åŠ¹åŒ–ï¼š
                                <ul class="ml-6 mt-1 list-disc">
                                    <li>Maps JavaScript API</li>
                                    <li>Places APIï¼ˆä½æ‰€æ¤œç´¢ç”¨ï¼‰</li>
                                </ul>
                            </li>
                            <li>èªè¨¼æƒ…å ±ã‹ã‚‰APIã‚­ãƒ¼ã‚’ä½œæˆ</li>
                            <li>APIã‚­ãƒ¼ã«é©åˆ‡ãªåˆ¶é™ã‚’è¨­å®š</li>
                        </ol>
                    </div>
                    <input 
                        type="text" 
                        id="apiKeyInput" 
                        placeholder="APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" 
                        class="w-full p-3 border border-gray-300 rounded-lg mb-4"
                    >
                    <div class="flex gap-2">
                        <button 
                            onclick="loadMapWithKey()" 
                            class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700"
                        >
                            åœ°å›³ã‚’èª­ã¿è¾¼ã‚€
                        </button>
                        <button 
                            onclick="saveApiKey()" 
                            class="bg-gray-600 text-white py-2 px-4 rounded-lg hover:bg-gray-700"
                        >
                            ä¿å­˜
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-4">
                        â€»APIã‚­ãƒ¼ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ã•ã‚Œã¾ã™ï¼ˆã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã®ã¿ï¼‰
                    </p>
                </div>
            </div>
        </div>

        <!-- å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
        <div class="grid lg:grid-cols-3 gap-6">
            <!-- è¾²åœ°ãƒ»ãƒ‘ãƒãƒ«è¨­å®š -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-xl font-bold mb-4">è¾²åœ°ãƒ»ãƒ‘ãƒãƒ«è¨­å®š</h2>
                
                <div class="space-y-4">
                    <div class="bg-purple-50 p-3 rounded-lg">
                        <h3 class="font-semibold text-purple-800 mb-2">è¾²åœ°å¯¸æ³•</h3>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    è¾²åœ°å¹…ï¼ˆæ±è¥¿æ–¹å‘ï¼‰(m)
                                </label>
                                <input type="number" id="fieldWidth" value="50" step="1" 
                                    class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    è¾²åœ°é•·ã•ï¼ˆå—åŒ—æ–¹å‘ï¼‰(m)
                                </label>
                                <input type="number" id="fieldLength" value="100" step="1"
                                    class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                            </div>
                        </div>
                    </div>

                    <div class="bg-blue-50 p-3 rounded-lg">
                        <h3 class="font-semibold text-blue-800 mb-2">ãƒ‘ãƒãƒ«ä»•æ§˜</h3>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    ãƒ‘ãƒãƒ«å¹… (mm)
                                </label>
                                <input type="number" id="panelWidth" value="2278" step="1"
                                    class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    ãƒ‘ãƒãƒ«é«˜ã• (mm)
                                </label>
                                <input type="number" id="panelHeight" value="1134" step="1"
                                    class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    å‚¾æ–œè§’åº¦ (åº¦)
                                </label>
                                <input type="number" id="tiltAngle" value="20" min="0" max="90"
                                    class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    ãƒ‘ãƒãƒ«1æšã®å®¹é‡ (W)
                                </label>
                                <input type="number" id="panelCapacity" value="400" step="10"
                                    class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- é…ç½®è¨­å®š -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-xl font-bold mb-4">é…ç½®è¨­å®š</h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            åˆ—é–“éš”ï¼ˆæ±è¥¿æ–¹å‘ï¼‰(mm)
                        </label>
                        <input type="number" id="columnSpacing" value="300" step="10"
                            class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        <p class="text-xs text-gray-500 mt-1">â€»æ±è¥¿æ–¹å‘ã®ãƒ‘ãƒãƒ«é–“éš”</p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            æ®µé–“éš”ï¼ˆå—åŒ—æ–¹å‘ï¼‰(mm)
                        </label>
                        <input type="number" id="rowSpacing" value="1000" step="10"
                            class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        <p class="text-xs text-gray-500 mt-1">â€»å—åŒ—æ–¹å‘ã®ãƒ‘ãƒãƒ«é–“éš”</p>
                    </div>

                    <button onclick="calculate()" 
                        class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-200 font-semibold">
                        è¨ˆç®—å®Ÿè¡Œ
                    </button>

                    <button onclick="generatePDF()" 
                        class="w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition duration-200 font-semibold"
                        id="pdfButton" style="display: none;">
                        ğŸ“„ é…ç½®å›³é¢ã‚’PDFå‡ºåŠ›
                    </button>

                    <!-- é…ç½®çµæœè¡¨ç¤º -->
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h3 class="font-semibold text-gray-800 mb-2">é…ç½®è¨ˆç®—çµæœ</h3>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-600">åˆ—æ•°ï¼ˆæ±è¥¿ï¼‰:</span>
                                <span class="font-bold" id="columnCount">0 åˆ—</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">æ®µæ•°ï¼ˆå—åŒ—ï¼‰:</span>
                                <span class="font-bold" id="rowCount">0 æ®µ</span>
                            </div>
                            <div class="flex justify-between border-t pt-2">
                                <span class="text-gray-600">ç·ãƒ‘ãƒãƒ«æ•°:</span>
                                <span class="font-bold text-lg text-indigo-600" id="totalPanels">0 æš</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- åˆ†æçµæœ -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-xl font-bold mb-4">åˆ†æçµæœ</h2>

                <div class="space-y-4">
                    <!-- é¢ç©æƒ…å ± -->
                    <div class="bg-blue-50 rounded-lg p-4">
                        <h3 class="font-semibold text-blue-800 mb-2">é¢ç©æƒ…å ±</h3>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-600">è¾²åœ°å…¨ä½“é¢ç©:</span>
                                <span class="font-bold" id="totalFieldArea">0 mÂ²</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">ãƒ‘ãƒãƒ«ç·é¢ç©:</span>
                                <span class="font-bold" id="totalPanelArea">0 mÂ²</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">æœ‰åŠ¹è¾²åœ°é¢ç©:</span>
                                <span class="font-bold" id="effectiveArea">0 mÂ²</span>
                            </div>
                        </div>
                    </div>

                    <!-- å…¨ä½“é®å…‰ç‡ -->
                    <div class="bg-gray-50 rounded-lg p-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm font-medium text-gray-700">å…¨ä½“é®å…‰ç‡</span>
                            <span class="text-2xl font-bold" id="shadingRatio">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3">
                            <div id="shadingBar" class="bg-gradient-to-r from-yellow-400 to-red-500 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">ãƒ‘ãƒãƒ«æ°´å¹³æŠ•å½±é¢ç© Ã· è¾²åœ°å…¨ä½“é¢ç©</p>
                    </div>

                    <!-- æ¨å®šç™ºé›»é‡ -->
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                        <h3 class="font-semibold text-yellow-800 mb-1">æ¨å®šç™ºé›»é‡</h3>
                        <p class="text-2xl font-bold text-yellow-700" id="estimatedPower">0 kW</p>
                        <p class="text-xs text-yellow-600 mt-1" id="panelCapacityInfo">â€»ãƒ‘ãƒãƒ«1æš400Wæƒ³å®š</p>
                    </div>

                    <!-- ä½œç‰©é©æ€§ -->
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <h3 class="font-semibold text-green-800 mb-2">æ¨å¥¨ä½œç‰©</h3>
                        <p class="text-green-700" id="cropSuitability">-</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ä½¿ã„æ–¹ -->
        <div class="mt-8 bg-white rounded-xl shadow-lg p-6">
            <h2 class="text-xl font-bold mb-4">ä½¿ã„æ–¹</h2>
            <ol class="list-decimal list-inside space-y-2 text-gray-700">
                <li>Google Maps APIã‚­ãƒ¼ã‚’å–å¾—ã—ã¦è¨­å®š</li>
                <li>ä½æ‰€æ¤œç´¢ã§ç›®çš„åœ°ã‚’æ¢ã™ã‹ã€ç¾åœ¨åœ°ãƒœã‚¿ãƒ³ã§ç§»å‹•</li>
                <li>åœ°å›³ä¸Šã§è¾²åœ°ã‚’é¸æŠï¼ˆå¤šè§’å½¢ã¾ãŸã¯é•·æ–¹å½¢ï¼‰- å®Ÿéš›ã®å¯¸æ³•ãŒè‡ªå‹•è¨ˆç®—ã•ã‚Œã¾ã™</li>
                <li>å¿…è¦ã«å¿œã˜ã¦é›¢éš”è·é›¢ã‚’è¨­å®š</li>
                <li>ãƒ‘ãƒãƒ«ä»•æ§˜ã¨é…ç½®é–“éš”ã‚’å…¥åŠ›</li>
                <li>ã€Œè¨ˆç®—å®Ÿè¡Œã€ã§é®å…‰ç‡ã¨æ¨å¥¨ä½œç‰©ã‚’ç¢ºèª</li>
                <li>ã€Œé…ç½®å›³é¢ã‚’PDFå‡ºåŠ›ã€ã§å°‚é–€çš„ãªå›³é¢ã‚’ç”Ÿæˆ</li>
            </ol>
            <div class="mt-4 bg-blue-50 p-3 rounded">
                <p class="text-sm text-blue-800">
                    <strong>ğŸ’¡ ãƒ’ãƒ³ãƒˆï¼š</strong>
                    ä½æ‰€æ¤œç´¢ã§ã¯ã€Œæ±äº¬éƒ½åƒä»£ç”°åŒºã€ã®ã‚ˆã†ãªä½æ‰€ã‚„ã€ã€Œæ±äº¬é§…ã€ã®ã‚ˆã†ãªåœ°åãƒ»æ–½è¨­åã§æ¤œç´¢ã§ãã¾ã™ã€‚
                    è¡›æ˜Ÿå†™çœŸã§è¾²åœ°ã‚’ç¢ºèªã—ãªãŒã‚‰é¸æŠã—ã¦ãã ã•ã„ã€‚
                </p>
            </div>
            <div class="mt-3 bg-green-50 p-3 rounded">
                <p class="text-sm text-green-800">
                    <strong>ğŸ“„ PDFå‡ºåŠ›ã«ã¤ã„ã¦ï¼š</strong>
                    è¨ˆç®—å®Ÿè¡Œå¾Œã€é…ç½®å›³é¢ã‚’PDFå½¢å¼ã§å‡ºåŠ›ã§ãã¾ã™ã€‚å¹³é¢å›³ã€å´é¢å›³ã€ä»•æ§˜ã€é®å…‰ç‡è¨ˆç®—ã‚’å«ã‚€å°‚é–€çš„ãªå›³é¢ãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚
                </p>
            </div>
        </div>
    </div>

    <script>
        let map;
        let drawingManager;
        let selectedPolygon;
        let actualDimensions = { width: 0, length: 0 };

        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰APIã‚­ãƒ¼ã‚’å–å¾—
        function getStoredApiKey() {
            return localStorage.getItem('googleMapsApiKey');
        }

        // APIã‚­ãƒ¼ã‚’ä¿å­˜
        function saveApiKey() {
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            if (apiKey) {
                localStorage.setItem('googleMapsApiKey', apiKey);
                alert('APIã‚­ãƒ¼ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
            }
        }

        // APIã‚­ãƒ¼ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º
        function showApiKeyForm() {
            document.getElementById('apiKeyOverlay').style.display = 'flex';
            const storedKey = getStoredApiKey();
            if (storedKey) {
                document.getElementById('apiKeyInput').value = storedKey;
            }
        }

        // APIã‚­ãƒ¼ã§åœ°å›³ã‚’èª­ã¿è¾¼ã‚€
        function loadMapWithKey() {
            const apiKey = document.getElementById('apiKeyInput').value.trim() || getStoredApiKey();
            if (!apiKey) {
                alert('APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            // æ—¢å­˜ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚¿ã‚°ã‚’å‰Šé™¤
            const existingScript = document.querySelector('script[src*="maps.googleapis.com"]');
            if (existingScript) {
                existingScript.remove();
            }

            // æ–°ã—ã„ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚¿ã‚°ã‚’ä½œæˆ
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&callback=initMap&libraries=drawing,geometry,places`;
            script.async = true;
            script.defer = true;
            script.onerror = function() {
                alert('APIã‚­ãƒ¼ãŒç„¡åŠ¹ã‹ã€Google Maps APIã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚APIã‚­ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                showApiKeyForm();
            };
            document.head.appendChild(script);

            // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’éè¡¨ç¤º
            document.getElementById('apiKeyOverlay').style.display = 'none';
        }

        // Google MapsåˆæœŸåŒ–
        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 36.2048, lng: 138.2529 }, // æ—¥æœ¬ã®ä¸­å¿ƒä»˜è¿‘
                zoom: 12,
                mapTypeId: 'satellite'
            });

            // ä½æ‰€æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ã®åˆæœŸåŒ–
            const searchBox = document.getElementById('searchBox');
            searchBox.style.display = 'block';
            const searchBoxControl = new google.maps.places.SearchBox(searchBox);
            
            // æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ã‚’åœ°å›³ã«é…ç½®
            map.controls[google.maps.ControlPosition.TOP_LEFT].push(searchBox);

            // æ¤œç´¢çµæœãŒé¸æŠã•ã‚ŒãŸã¨ãã®å‡¦ç†
            searchBoxControl.addListener('places_changed', function() {
                const places = searchBoxControl.getPlaces();

                if (places.length === 0) {
                    return;
                }

                // æœ€åˆã®æ¤œç´¢çµæœã«ç§»å‹•
                const place = places[0];
                if (!place.geometry || !place.geometry.location) {
                    alert('å ´æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
                    return;
                }

                // åœ°å›³ã‚’ç§»å‹•
                if (place.geometry.viewport) {
                    map.fitBounds(place.geometry.viewport);
                } else {
                    map.setCenter(place.geometry.location);
                    map.setZoom(17);
                }
            });

            // åœ°å›³ã®è¡¨ç¤ºç¯„å›²ãŒå¤‰æ›´ã•ã‚ŒãŸã¨ãã«æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ã®æ¤œç´¢ç¯„å›²ã‚’æ›´æ–°
            map.addListener('bounds_changed', function() {
                searchBoxControl.setBounds(map.getBounds());
            });

            // æç”»ãƒ„ãƒ¼ãƒ«
            drawingManager = new google.maps.drawing.DrawingManager({
                drawingMode: null,
                drawingControl: true,
                drawingControlOptions: {
                    position: google.maps.ControlPosition.TOP_CENTER,
                    drawingModes: ['polygon', 'rectangle']
                },
                polygonOptions: {
                    fillColor: '#00ff00',
                    fillOpacity: 0.3,
                    strokeWeight: 2,
                    strokeColor: '#00ff00',
                    editable: true,
                    draggable: true
                },
                rectangleOptions: {
                    fillColor: '#00ff00',
                    fillOpacity: 0.3,
                    strokeWeight: 2,
                    strokeColor: '#00ff00',
                    editable: true,
                    draggable: true
                }
            });
            drawingManager.setMap(map);

            // å›³å½¢å®Œæˆæ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆ
            google.maps.event.addListener(drawingManager, 'overlaycomplete', function(event) {
                if (selectedPolygon) {
                    selectedPolygon.setMap(null);
                }
                selectedPolygon = event.overlay;
                drawingManager.setDrawingMode(null);

                calculateAreaAndDimensions();

                // ç·¨é›†æ™‚ã®å†è¨ˆç®—
                if (event.type === 'polygon') {
                    google.maps.event.addListener(selectedPolygon.getPath(), 'set_at', calculateAreaAndDimensions);
                    google.maps.event.addListener(selectedPolygon.getPath(), 'insert_at', calculateAreaAndDimensions);
                } else if (event.type === 'rectangle') {
                    google.maps.event.addListener(selectedPolygon, 'bounds_changed', calculateAreaAndDimensions);
                }
            });

            // ã‚«ã‚¹ã‚¿ãƒ ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«
            const clearButton = document.createElement('div');
            clearButton.className = 'map-controls';
            clearButton.innerHTML = '<button class="controls-button" onclick="clearSelection()">é¸æŠã‚’ã‚¯ãƒªã‚¢</button>';
            map.controls[google.maps.ControlPosition.TOP_RIGHT].push(clearButton);

            // ç¾åœ¨åœ°ãƒœã‚¿ãƒ³
            const locationButton = document.createElement('div');
            locationButton.className = 'map-controls';
            locationButton.innerHTML = '<button class="controls-button" onclick="getCurrentLocation()">ğŸ“ ç¾åœ¨åœ°</button>';
            map.controls[google.maps.ControlPosition.TOP_RIGHT].push(locationButton);

            // APIã‚­ãƒ¼è­¦å‘Šã‚’éè¡¨ç¤º
            document.getElementById('apiKeyWarning').style.display = 'none';
        }

        // ç¾åœ¨åœ°ã‚’å–å¾—
        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const pos = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        map.setCenter(pos);
                        map.setZoom(17);
                        
                        // ç¾åœ¨åœ°ã«ãƒãƒ¼ã‚«ãƒ¼ã‚’è¡¨ç¤º
                        new google.maps.Marker({
                            position: pos,
                            map: map,
                            title: 'ç¾åœ¨åœ°',
                            icon: {
                                path: google.maps.SymbolPath.CIRCLE,
                                scale: 10,
                                fillColor: '#4285F4',
                                fillOpacity: 1,
                                strokeColor: '#ffffff',
                                strokeWeight: 2
                            }
                        });
                    },
                    () => {
                        alert('ç¾åœ¨åœ°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ä½ç½®æƒ…å ±ã®è¨±å¯ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                    }
                );
            } else {
                alert('ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ä½ç½®æƒ…å ±ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚');
            }
        }

        // é¢ç©ã¨å¯¸æ³•ã‚’è¨ˆç®—
        function calculateAreaAndDimensions() {
            let area, bounds;
            
            if (selectedPolygon.getBounds) {
                // é•·æ–¹å½¢ã®å ´åˆ
                bounds = selectedPolygon.getBounds();
            } else {
                // å¤šè§’å½¢ã®å ´åˆ - ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ã‚’è¨ˆç®—
                const path = selectedPolygon.getPath();
                bounds = new google.maps.LatLngBounds();
                path.forEach(function(latLng) {
                    bounds.extend(latLng);
                });
                area = google.maps.geometry.spherical.computeArea(path);
            }

            const ne = bounds.getNorthEast();
            const sw = bounds.getSouthWest();
            const se = new google.maps.LatLng(sw.lat(), ne.lng());
            const nw = new google.maps.LatLng(ne.lat(), sw.lng());

            // å®Ÿéš›ã®å¯¸æ³•ã‚’è¨ˆç®—ï¼ˆãƒ¡ãƒ¼ãƒˆãƒ«å˜ä½ï¼‰
            const width = google.maps.geometry.spherical.computeDistanceBetween(sw, se);
            const length = google.maps.geometry.spherical.computeDistanceBetween(sw, nw);

            // é•·æ–¹å½¢ã®å ´åˆã®é¢ç©è¨ˆç®—
            if (!area) {
                area = width * length;
            }

            // å®Ÿæ¸¬å€¤ã‚’ä¿å­˜
            actualDimensions = {
                width: width,
                length: length
            };

            // è¡¨ç¤ºæ›´æ–°
            document.getElementById('areaInfo').style.display = 'block';
            document.getElementById('selectedArea').textContent = Math.round(area).toLocaleString();
            document.getElementById('actualWidth').textContent = width.toFixed(1);
            document.getElementById('actualLength').textContent = length.toFixed(1);

            // è¾²åœ°å¯¸æ³•ã‚’æ›´æ–°
            updateFieldDimensions();
        }

        // é›¢éš”ã‚’è€ƒæ…®ã—ãŸè¾²åœ°å¯¸æ³•ã‚’æ›´æ–°
        function updateFieldDimensions() {
            const margin = parseFloat(document.getElementById('fieldMargin').value) || 0;
            
            // é›¢éš”ã‚’è€ƒæ…®ã—ãŸå¯¸æ³•ã‚’è¨ˆç®—
            const effectiveWidth = Math.max(0, actualDimensions.width - (margin * 2));
            const effectiveLength = Math.max(0, actualDimensions.length - (margin * 2));
            
            // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«åæ˜ 
            document.getElementById('fieldWidth').value = Math.round(effectiveWidth);
            document.getElementById('fieldLength').value = Math.round(effectiveLength);
            
            // è‡ªå‹•è¨ˆç®—
            calculate();
        }

        // é¸æŠã‚¯ãƒªã‚¢
        function clearSelection() {
            if (selectedPolygon) {
                selectedPolygon.setMap(null);
                selectedPolygon = null;
                document.getElementById('areaInfo').style.display = 'none';
                actualDimensions = { width: 0, length: 0 };
            }
        }

        // è¨ˆç®—å®Ÿè¡Œ
        function calculate() {
            // å…¥åŠ›å€¤å–å¾—
            const fieldWidth = parseFloat(document.getElementById('fieldWidth').value) || 0;
            const fieldLength = parseFloat(document.getElementById('fieldLength').value) || 0;
            const panelWidth = parseFloat(document.getElementById('panelWidth').value) || 0;
            const panelHeight = parseFloat(document.getElementById('panelHeight').value) || 0;
            const tiltAngle = parseFloat(document.getElementById('tiltAngle').value) || 0;
            const columnSpacing = parseFloat(document.getElementById('columnSpacing').value) || 0;
            const rowSpacing = parseFloat(document.getElementById('rowSpacing').value) || 0;
            const panelCapacity = parseFloat(document.getElementById('panelCapacity').value) || 400;
            const fieldMargin = parseFloat(document.getElementById('fieldMargin').value) || 0;

            // é¢ç©è¨ˆç®—
            const totalFieldArea = fieldWidth * fieldLength;
            const singlePanelArea = (panelWidth * panelHeight) / 1000000; // mmÂ² to mÂ²
            const panelHorizontalProjection = singlePanelArea * Math.cos((tiltAngle * Math.PI) / 180);

            // é…ç½®è¨ˆç®—ï¼ˆä¿®æ­£ï¼šåˆ—=æ±è¥¿ã€æ®µ=å—åŒ—ï¼‰
            const columnCount = Math.floor((fieldWidth * 1000) / (panelWidth + columnSpacing));
            const rowCount = Math.floor((fieldLength * 1000) / (panelHeight + rowSpacing));
            const totalPanels = rowCount * columnCount;

            // ãƒ‘ãƒãƒ«ç·é¢ç©
            const totalPanelArea = totalPanels * singlePanelArea;
            const totalPanelHorizontalArea = totalPanels * panelHorizontalProjection;

            // æœ‰åŠ¹è¾²åœ°é¢ç©ï¼ˆé›¢éš”ã‚’è€ƒæ…®ï¼‰
            const effectiveArea = actualDimensions.width * actualDimensions.length - 
                                 (fieldMargin * 2 * (actualDimensions.width + actualDimensions.length - 2 * fieldMargin));

            // é®å…‰ç‡
            const shadingRatio = totalFieldArea > 0 ? (totalPanelHorizontalArea / totalFieldArea) * 100 : 0;

            // æ¨å®šç™ºé›»é‡ï¼ˆã‚«ã‚¹ã‚¿ãƒ å®¹é‡ã‚’ä½¿ç”¨ï¼‰
            const estimatedPower = (totalPanels * panelCapacity) / 1000; // W to kW

            // ä½œç‰©é©æ€§
            let cropSuitability;
            if (shadingRatio < 20) {
                cropSuitability = 'æ—¥ç…§è¦æ±‚å‹ä½œç‰©ï¼ˆãƒˆãƒãƒˆã€ã‚­ãƒ¥ã‚¦ãƒªã€ãƒŠã‚¹ã€ãƒ”ãƒ¼ãƒãƒ³ç­‰ï¼‰';
            } else if (shadingRatio < 35) {
                cropSuitability = 'åŠæ—¥é™°é©å¿œå‹ä½œç‰©ï¼ˆãƒ¬ã‚¿ã‚¹ã€ãƒ›ã‚¦ãƒ¬ãƒ³ã‚½ã‚¦ã€å°æ¾èœç­‰ï¼‰';
            } else if (shadingRatio < 50) {
                cropSuitability = 'æ—¥é™°é©å¿œå‹ä½œç‰©ï¼ˆãƒŸãƒ§ã‚¦ã‚¬ã€ã‚·ã‚¤ã‚¿ã‚±ã€å±±èœç­‰ï¼‰';
            } else {
                cropSuitability = 'ç•œç”£ãƒ»ç‰§è‰åˆ©ç”¨ï¼ˆç‰›ã€ç¾Šã®æ”¾ç‰§ã€é£¼æ–™ä½œç‰©ç­‰ï¼‰';
            }

            // çµæœè¡¨ç¤º
            document.getElementById('columnCount').textContent = columnCount + ' åˆ—';
            document.getElementById('rowCount').textContent = rowCount + ' æ®µ';
            document.getElementById('totalPanels').textContent = totalPanels + ' æš';
            document.getElementById('totalFieldArea').textContent = Math.round(totalFieldArea).toLocaleString() + ' mÂ²';
            document.getElementById('totalPanelArea').textContent = Math.round(totalPanelArea).toLocaleString() + ' mÂ²';
            document.getElementById('effectiveArea').textContent = Math.round(effectiveArea).toLocaleString() + ' mÂ²';
            document.getElementById('shadingRatio').textContent = Math.round(shadingRatio * 10) / 10 + '%';
            document.getElementById('shadingBar').style.width = Math.min(shadingRatio, 100) + '%';
            document.getElementById('estimatedPower').textContent = Math.round(estimatedPower * 10) / 10 + ' kW';
            document.getElementById('panelCapacityInfo').textContent = `â€»ãƒ‘ãƒãƒ«1æš${panelCapacity}Wæƒ³å®š`;
            document.getElementById('cropSuitability').textContent = cropSuitability;

            // é®å…‰ç‡ã«å¿œã˜ãŸè‰²å¤‰æ›´
            const shadingRatioElement = document.getElementById('shadingRatio');
            if (shadingRatio < 20) {
                shadingRatioElement.className = 'text-2xl font-bold text-green-600';
            } else if (shadingRatio < 35) {
                shadingRatioElement.className = 'text-2xl font-bold text-yellow-600';
            } else if (shadingRatio < 50) {
                shadingRatioElement.className = 'text-2xl font-bold text-orange-600';
            } else {
                shadingRatioElement.className = 'text-2xl font-bold text-red-600';
            }

            // PDFå‡ºåŠ›ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
            if (totalPanels > 0) {
                document.getElementById('pdfButton').style.display = 'block';
            }
        }

        // PDFç”Ÿæˆé–¢æ•°
        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'landscape',
                unit: 'mm',
                format: 'a3'
            });

            // è¨­å®šå€¤ã‚’å–å¾—
            const fieldWidth = parseFloat(document.getElementById('fieldWidth').value) || 0;
            const fieldLength = parseFloat(document.getElementById('fieldLength').value) || 0;
            const panelWidth = parseFloat(document.getElementById('panelWidth').value) || 0;
            const panelHeight = parseFloat(document.getElementById('panelHeight').value) || 0;
            const tiltAngle = parseFloat(document.getElementById('tiltAngle').value) || 0;
            const columnSpacing = parseFloat(document.getElementById('columnSpacing').value) || 0;
            const rowSpacing = parseFloat(document.getElementById('rowSpacing').value) || 0;
            const panelCapacity = parseFloat(document.getElementById('panelCapacity').value) || 400;
            const columnCount = Math.floor((fieldWidth * 1000) / (panelWidth + columnSpacing));
            const rowCount = Math.floor((fieldLength * 1000) / (panelHeight + rowSpacing));
            const totalPanels = rowCount * columnCount;

            // é®å…‰ç‡è¨ˆç®—
            const singlePanelArea = (panelWidth * panelHeight) / 1000000;
            const panelHorizontalProjection = singlePanelArea * Math.cos((tiltAngle * Math.PI) / 180);
            const totalPanelHorizontalArea = totalPanels * panelHorizontalProjection;
            const totalFieldArea = fieldWidth * fieldLength;
            const shadingRatio = (totalPanelHorizontalArea / totalFieldArea) * 100;
            const totalPower = (totalPanels * panelCapacity) / 1000;

            // å›³é¢æ ã‚’æç”»
            doc.setLineWidth(0.5);
            doc.rect(5, 5, 410, 287);
            doc.setLineWidth(1);
            doc.rect(10, 10, 400, 277);

            // ã‚¿ã‚¤ãƒˆãƒ«
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(18);
            doc.text(`å–¶è¾²å‹å¤ªé™½å…‰ç™ºé›»é…ç½®å›³ ${totalPower.toFixed(1)}kW é®å…‰ç‡${shadingRatio.toFixed(1)}%`, 210, 25, { align: 'center' });

            // å¹³é¢å›³ã‚¨ãƒªã‚¢
            const planX = 20;
            const planY = 40;
            const planWidth = 280;
            const planHeight = 180;
            
            // å¹³é¢å›³ã®æ 
            doc.setLineWidth(0.5);
            doc.rect(planX, planY, planWidth, planHeight);

            // ã‚¹ã‚±ãƒ¼ãƒ«è¨ˆç®—
            const scaleX = (planWidth - 20) / (fieldWidth * 1000);
            const scaleY = (planHeight - 20) / (fieldLength * 1000);
            const scale = Math.min(scaleX, scaleY);

            // è¾²åœ°å¤–å½¢
            const scaledFieldWidth = fieldWidth * 1000 * scale;
            const scaledFieldLength = fieldLength * 1000 * scale;
            const offsetX = planX + (planWidth - scaledFieldWidth) / 2;
            const offsetY = planY + (planHeight - scaledFieldLength) / 2;

            doc.setLineWidth(1);
            doc.rect(offsetX, offsetY, scaledFieldWidth, scaledFieldLength);

            // ãƒ‘ãƒãƒ«é…ç½®ã‚’æç”»
            doc.setLineWidth(0.3);
            doc.setFillColor(200, 200, 255);
            for (let row = 0; row < rowCount; row++) {
                for (let col = 0; col < columnCount; col++) {
                    const x = offsetX + col * (panelWidth + columnSpacing) * scale;
                    const y = offsetY + row * (panelHeight + rowSpacing) * scale;
                    const w = panelWidth * scale;
                    const h = panelHeight * scale;
                    doc.rect(x, y, w, h, 'FD');
                }
            }

            // å¯¸æ³•ç·šï¼ˆæ¨ªï¼‰
            doc.setLineWidth(0.3);
            doc.line(offsetX, offsetY + scaledFieldLength + 10, offsetX + scaledFieldWidth, offsetY + scaledFieldLength + 10);
            doc.line(offsetX, offsetY + scaledFieldLength + 8, offsetX, offsetY + scaledFieldLength + 12);
            doc.line(offsetX + scaledFieldWidth, offsetY + scaledFieldLength + 8, offsetX + scaledFieldWidth, offsetY + scaledFieldLength + 12);
            doc.setFontSize(10);
            doc.text(`${fieldWidth * 1000}`, offsetX + scaledFieldWidth / 2, offsetY + scaledFieldLength + 15, { align: 'center' });

            // å¯¸æ³•ç·šï¼ˆç¸¦ï¼‰
            doc.line(offsetX + scaledFieldWidth + 10, offsetY, offsetX + scaledFieldWidth + 10, offsetY + scaledFieldLength);
            doc.line(offsetX + scaledFieldWidth + 8, offsetY, offsetX + scaledFieldWidth + 12, offsetY);
            doc.line(offsetX + scaledFieldWidth + 8, offsetY + scaledFieldLength, offsetX + scaledFieldWidth + 12, offsetY + scaledFieldLength);
            doc.save();
            doc.text(0, 0, `${fieldLength * 1000}`, {
                angle: 90
            });
            doc.restore();
            const textWidth = doc.getTextWidth(`${fieldLength * 1000}`);
            doc.text(`${fieldLength * 1000}`, offsetX + scaledFieldWidth + 15, offsetY + scaledFieldLength / 2 + textWidth / 2, { angle: 90 });

            // å´é¢å›³
            const sideX = 310;
            const sideY = 100;
            doc.setLineWidth(0.5);
            doc.rect(sideX, sideY, 90, 60);
            
            // å´é¢å›³ã®å†…å®¹
            doc.setLineWidth(0.3);
            // åœ°é¢
            doc.line(sideX + 10, sideY + 50, sideX + 80, sideY + 50);
            // æ”¯æŸ±
            doc.line(sideX + 25, sideY + 50, sideX + 25, sideY + 30);
            doc.line(sideX + 65, sideY + 50, sideX + 65, sideY + 30);
            // ãƒ‘ãƒãƒ«ï¼ˆå‚¾æ–œï¼‰
            const panelTop = sideY + 30 - Math.sin((tiltAngle * Math.PI) / 180) * 15;
            doc.line(sideX + 20, sideY + 30, sideX + 70, panelTop);
            doc.setLineWidth(2);
            doc.line(sideX + 20, sideY + 30, sideX + 70, panelTop);
            
            // å‚¾æ–œè§’åº¦è¡¨ç¤º
            doc.setFontSize(9);
            doc.text(`å‚¾æ–œ${tiltAngle}Â°`, sideX + 45, sideY + 20, { align: 'center' });

            // ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ä»•æ§˜ãƒœãƒƒã‚¯ã‚¹
            const specX = 310;
            const specY = 40;
            doc.setLineWidth(0.5);
            doc.rect(specX, specY, 90, 50);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(10);
            doc.text('â—‡ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ä»•æ§˜', specX + 5, specY + 8);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            doc.text(`å‹å¼ï¼š${panelCapacity}Wå¤ªé™½é›»æ± `, specX + 5, specY + 16);
            doc.text(`å¯¸æ³•ï¼š${panelWidth}Ã—${panelHeight}Ã—35mm`, specX + 5, specY + 23);
            doc.text(`æšæ•°ï¼š${totalPanels}æš`, specX + 5, specY + 30);
            doc.text(`å®¹é‡ï¼š${totalPower.toFixed(2)}kW`, specX + 5, specY + 37);
            doc.text(`é‡é‡ï¼šç´„20kg/æš`, specX + 5, specY + 44);

            // é®å…‰ç‡è¨ˆç®—ãƒœãƒƒã‚¯ã‚¹
            const calcX = 20;
            const calcY = 230;
            doc.setLineWidth(0.5);
            doc.rect(calcX, calcY, 280, 45);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(10);
            doc.text('â—‡é®å…‰ç‡', calcX + 5, calcY + 8);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            doc.text(`ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ç·é¢ç©ï¼š${totalPanels}æš Ã— ${singlePanelArea.toFixed(2)}mÂ² = ${(totalPanels * singlePanelArea).toFixed(1)}mÂ²`, calcX + 5, calcY + 16);
            doc.text(`æ°´å¹³æŠ•å½±é¢ç©ï¼š${(totalPanels * panelHorizontalProjection).toFixed(1)}mÂ²ï¼ˆå‚¾æ–œ${tiltAngle}åº¦è€ƒæ…®ï¼‰`, calcX + 5, calcY + 24);
            doc.text(`å æœ‰ç·é¢ç©ï¼š${totalFieldArea.toFixed(1)}mÂ²`, calcX + 5, calcY + 32);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(255, 0, 0);
            doc.text(`é®å…‰ç‡=${(totalPanels * panelHorizontalProjection).toFixed(1)}mÂ² Ã· ${totalFieldArea.toFixed(1)}mÂ² Ã— 100 = ${shadingRatio.toFixed(2)}%`, calcX + 5, calcY + 40);
            doc.setTextColor(0, 0, 0);

            // è¡¨é¡Œæ¬„
            doc.setLineWidth(0.5);
            doc.rect(310, 230, 90, 45);
            doc.line(310, 240, 400, 240);
            doc.line(310, 250, 400, 250);
            doc.line(310, 260, 400, 260);
            doc.line(340, 230, 340, 275);
            doc.line(370, 230, 370, 275);
            
            doc.setFontSize(8);
            doc.text('ç•ªå·', 325, 237, { align: 'center' });
            doc.text('ç¸®å°º', 355, 237, { align: 'center' });
            doc.text('è¨­è¨ˆå¹´æœˆæ—¥', 385, 237, { align: 'center' });
            doc.text('è¨­è¨ˆ', 325, 247, { align: 'center' });
            doc.text('å›³é¢åç§°', 325, 257, { align: 'center' });
            doc.text('ä¼šç¤¾å', 325, 267, { align: 'center' });
            
            // æ—¥ä»˜
            const today = new Date();
            const dateStr = `${today.getFullYear()}/${today.getMonth() + 1}/${today.getDate()}`;
            doc.setFontSize(9);
            doc.text(dateStr, 385, 247, { align: 'center' });
            doc.text('å–¶è¾²å‹å¤ªé™½å…‰ç™ºé›»', 355, 257, { align: 'center' });
            doc.text('é…ç½®å›³', 355, 267, { align: 'center' });

            // æ–¹ä½è¨˜å·
            const compassX = 380;
            const compassY = 190;
            doc.setLineWidth(0.5);
            doc.circle(compassX, compassY, 15);
            doc.setLineWidth(1);
            // åŒ—å‘ãçŸ¢å°
            doc.line(compassX, compassY - 10, compassX, compassY + 10);
            doc.line(compassX, compassY - 10, compassX - 3, compassY - 5);
            doc.line(compassX, compassY - 10, compassX + 3, compassY - 5);
            doc.setFontSize(10);
            doc.text('N', compassX, compassY - 18, { align: 'center' });

            // PDFã‚’ä¿å­˜
            const filename = `å–¶è¾²å‹å¤ªé™½å…‰ç™ºé›»_é…ç½®å›³_${totalPower.toFixed(1)}kW_é®å…‰ç‡${shadingRatio.toFixed(1)}%.pdf`;
            doc.save(filename);
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®å‡¦ç†
        document.addEventListener('DOMContentLoaded', function() {
            // å…¥åŠ›å¤‰æ›´æ™‚ã®è‡ªå‹•è¨ˆç®—
            const inputs = document.querySelectorAll('input[type="number"]');
            inputs.forEach(input => {
                input.addEventListener('input', calculate);
            });
            calculate();

            // ä¿å­˜ã•ã‚ŒãŸAPIã‚­ãƒ¼ãŒã‚ã‚‹ã‹ç¢ºèª
            const storedApiKey = getStoredApiKey();
            if (storedApiKey) {
                // è‡ªå‹•çš„ã«åœ°å›³ã‚’èª­ã¿è¾¼ã‚€
                document.getElementById('apiKeyInput').value = storedApiKey;
                loadMapWithKey();
            } else {
                // APIã‚­ãƒ¼å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º
                document.getElementById('apiKeyWarning').style.display = 'block';
            }
        });
    </script>
</body>
</html>
