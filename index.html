<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>営農型太陽光発電 遮光率分析ツール</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        #map { height: 400px; width: 100%; position: relative; }
        .map-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7); display: flex;
            align-items: center; justify-content: center; z-index: 1000;
        }
        .api-key-form {
            background: white; padding: 30px; border-radius: 10px;
            max-width: 500px; width: 90%;
        }
        .map-controls {
            background-color: white;
            border: 2px solid #ddd;
            border-radius: 3px;
            box-shadow: 0 2px 6px rgba(0,0,0,.3);
            margin: 10px;
            padding: 10px;
            text-align: center;
        }
        .controls-button {
            background-color: #4CAF50;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 2px;
        }
        .controls-button:hover {
            background-color: #45a049;
        }
        .controls-button.active {
            background-color: #2196F3;
        }
        .controls-button.measuring {
            background-color: #FF9800;
        }
        .area-info {
            background-color: white;
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-top: 10px;
        }
        #searchBox {
            margin: 10px;
            padding: 10px 15px;
            font-size: 14px;
            width: 300px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            background-color: white;
        }
        #searchBox:focus {
            border-color: #4285f4;
            outline: none;
        }
        #layoutPreview {
            width: 100%;
            height: 300px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f9f9f9;
            position: relative;
            overflow: hidden;
        }
        .panel-preview {
            position: absolute;
            background: #4169E1;
            border: 1px solid #1E40AF;
            opacity: 0.8;
        }
        @font-face {
            font-family: 'NotoSansJP';
            src: url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap');
        }
    </style>
</head>
<body class="bg-gradient-to-br from-green-50 to-blue-50 min-h-screen">
    <div class="max-w-7xl mx-auto p-6">
        <!-- ヘッダー -->
        <div class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">
                営農型太陽光発電 遮光率分析ツール
            </h1>
            <p class="text-gray-600">Google Mapsで農地を選択し、太陽光パネル配置と遮光率を分析します</p>
        </div>

        <!-- Google Maps統合セクション -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <h2 class="text-xl font-bold mb-4">農地選択（Google Maps）</h2>
            <div class="mb-3">
                <input id="searchBox" type="text" placeholder="住所や地名を検索（例：○○市△△町、□□農園）" 
                    class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                    style="display: none;">
            </div>
            <div id="map"></div>
            <div class="area-info" id="areaInfo" style="display: none;">
                <p>選択された農地面積: <span id="selectedArea" class="font-bold">0</span> m²</p>
                <p>測定サイズ: 幅（東西） <span id="measuredWidth" class="font-bold">0</span> m × 長さ（南北） <span id="measuredLength" class="font-bold">0</span> m</p>
                <p class="text-sm text-gray-600 mt-1">※測定ツールで正確な寸法を測定してください</p>
                <div class="mt-2 p-2 bg-yellow-50 rounded">
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        農地からの離隔距離 (m)
                    </label>
                    <input type="number" id="fieldMargin" value="1" min="0" step="0.5" 
                        class="w-32 p-1 border border-gray-300 rounded"
                        onchange="updateFieldDimensions()">
                    <span class="text-xs text-gray-600 ml-2">※四方から同じ距離を離します</span>
                </div>
            </div>
            <div class="area-info" id="apiKeyWarning" style="display: none;">
                <p class="text-sm text-yellow-800">
                    <strong>重要：</strong>APIキーが設定されていません。
                    <button onclick="showApiKeyForm()" class="underline text-yellow-900">設定する</button>
                </p>
            </div>
            <div class="map-overlay" id="apiKeyOverlay" style="display: none;">
                <div class="api-key-form">
                    <h3 class="text-xl font-bold mb-4">Google Maps APIキーの設定</h3>
                    <p class="text-gray-600 mb-4">
                        このツールを使用するには、Google Maps APIキーが必要です。
                    </p>
                    <div class="bg-blue-50 p-4 rounded mb-4">
                        <h4 class="font-bold text-blue-800 mb-2">APIキーの取得方法：</h4>
                        <ol class="list-decimal list-inside text-sm text-blue-700 space-y-1">
                            <li><a href="https://console.cloud.google.com/" target="_blank" class="underline">Google Cloud Console</a>にアクセス</li>
                            <li>プロジェクトを作成</li>
                            <li>以下のAPIを有効化：
                                <ul class="ml-6 mt-1 list-disc">
                                    <li>Maps JavaScript API</li>
                                    <li>Places API（住所検索用）</li>
                                    <li>Geocoding API（逆ジオコーディング用）</li>
                                </ul>
                            </li>
                            <li>認証情報からAPIキーを作成</li>
                            <li>APIキーに適切な制限を設定</li>
                        </ol>
                    </div>
                    <input 
                        type="text" 
                        id="apiKeyInput" 
                        placeholder="APIキーを入力してください" 
                        class="w-full p-3 border border-gray-300 rounded-lg mb-4"
                    >
                    <div class="flex gap-2">
                        <button 
                            onclick="loadMapWithKey()" 
                            class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700"
                        >
                            地図を読み込む
                        </button>
                        <button 
                            onclick="saveApiKey()" 
                            class="bg-gray-600 text-white py-2 px-4 rounded-lg hover:bg-gray-700"
                        >
                            保存
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-4">
                        ※APIキーはローカルストレージに保存されます（このブラウザのみ）
                    </p>
                </div>
            </div>
        </div>

        <!-- 入力フォーム -->
        <div class="grid lg:grid-cols-3 gap-6">
            <!-- 農地・パネル設定 -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-xl font-bold mb-4">農地・パネル設定</h2>
                
                <div class="space-y-4">
                    <div class="bg-purple-50 p-3 rounded-lg">
                        <h3 class="font-semibold text-purple-800 mb-2">農地寸法</h3>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    農地幅（東西方向）(m)
                                </label>
                                <input type="number" id="fieldWidth" value="50" step="1" 
                                    class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    農地長さ（南北方向）(m)
                                </label>
                                <input type="number" id="fieldLength" value="100" step="1"
                                    class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                            </div>
                        </div>
                    </div>

                    <div class="bg-blue-50 p-3 rounded-lg">
                        <h3 class="font-semibold text-blue-800 mb-2">パネル仕様</h3>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    パネル幅 (mm)
                                </label>
                                <input type="number" id="panelWidth" value="2278" step="1"
                                    class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    パネル高さ (mm)
                                </label>
                                <input type="number" id="panelHeight" value="1134" step="1"
                                    class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    傾斜角度 (度)
                                </label>
                                <input type="number" id="tiltAngle" value="20" min="0" max="90"
                                    class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    パネル1枚の容量 (W)
                                </label>
                                <input type="number" id="panelCapacity" value="600" step="10"
                                    class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 配置設定 -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-xl font-bold mb-4">配置設定</h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            列間隔（東西方向）(mm)
                        </label>
                        <input type="number" id="columnSpacing" value="300" step="10"
                            class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        <p class="text-xs text-gray-500 mt-1">※東西方向のパネル間隔</p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            段間隔（南北方向）(mm)
                        </label>
                        <input type="number" id="rowSpacing" value="1000" step="10"
                            class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        <p class="text-xs text-gray-500 mt-1">※南北方向のパネル間隔</p>
                    </div>

                    <button onclick="calculate()" 
                        class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-200 font-semibold">
                        計算実行
                    </button>

                    <button onclick="generatePDF()" 
                        class="w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition duration-200 font-semibold"
                        id="pdfButton" style="display: none;">
                        📄 配置図面をPDF出力
                    </button>

                    <!-- 配置結果表示 -->
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h3 class="font-semibold text-gray-800 mb-2">配置計算結果</h3>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-600">列数（東西）:</span>
                                <span class="font-bold" id="columnCount">0 列</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">段数（南北）:</span>
                                <span class="font-bold" id="rowCount">0 段</span>
                            </div>
                            <div class="flex justify-between border-t pt-2">
                                <span class="text-gray-600">総パネル数:</span>
                                <span class="font-bold text-lg text-indigo-600" id="totalPanels">0 枚</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 分析結果 -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-xl font-bold mb-4">分析結果</h2>

                <div class="space-y-4">
                    <!-- 面積情報 -->
                    <div class="bg-blue-50 rounded-lg p-4">
                        <h3 class="font-semibold text-blue-800 mb-2">面積情報</h3>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-600">農地全体面積:</span>
                                <span class="font-bold" id="totalFieldArea">0 m²</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">パネル総面積:</span>
                                <span class="font-bold" id="totalPanelArea">0 m²</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">有効農地面積:</span>
                                <span class="font-bold" id="effectiveArea">0 m²</span>
                            </div>
                        </div>
                    </div>

                    <!-- 全体遮光率 -->
                    <div class="bg-gray-50 rounded-lg p-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm font-medium text-gray-700">全体遮光率</span>
                            <span class="text-2xl font-bold" id="shadingRatio">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3">
                            <div id="shadingBar" class="bg-gradient-to-r from-yellow-400 to-red-500 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">パネル水平投影面積 ÷ 農地全体面積</p>
                    </div>

                    <!-- 推定発電量 -->
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                        <h3 class="font-semibold text-yellow-800 mb-1">推定発電量</h3>
                        <p class="text-2xl font-bold text-yellow-700" id="estimatedPower">0 kW</p>
                        <p class="text-xs text-yellow-600 mt-1" id="panelCapacityInfo">※パネル1枚600W想定</p>
                    </div>

                    <!-- 作物適性 -->
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <h3 class="font-semibold text-green-800 mb-2">推奨作物</h3>
                        <p class="text-green-700" id="cropSuitability">-</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 配置イメージ図 -->
        <div class="mt-6 bg-white rounded-xl shadow-lg p-6" id="layoutPreviewSection" style="display: none;">
            <h2 class="text-xl font-bold mb-4">配置イメージ図</h2>
            <div id="layoutPreview"></div>
            <p class="text-sm text-gray-600 mt-2">※青色の矩形が太陽光パネルの配置位置を示します</p>
        </div>

        <!-- 使い方 -->
        <div class="mt-8 bg-white rounded-xl shadow-lg p-6">
            <h2 class="text-xl font-bold mb-4">使い方</h2>
            <ol class="list-decimal list-inside space-y-2 text-gray-700">
                <li>Google Maps APIキーを取得して設定</li>
                <li>住所検索で目的地を探すか、現在地ボタンで移動</li>
                <li>「測定開始」ボタンで農地の幅と長さを正確に測定</li>
                <li>必要に応じて離隔距離を設定</li>
                <li>パネル仕様と配置間隔を入力</li>
                <li>「計算実行」で遮光率と配置イメージを確認</li>
                <li>「配置図面をPDF出力」で専門的な図面を生成</li>
            </ol>
            <div class="mt-4 bg-blue-50 p-3 rounded">
                <p class="text-sm text-blue-800">
                    <strong>💡 測定のヒント：</strong>
                    「測定開始」ボタンをクリック後、農地の幅（東西）と長さ（南北）をそれぞれクリックして測定してください。
                </p>
            </div>
        </div>
    </div>

    <script>
        let map;
        let drawingManager;
        let selectedPolygon;
        let measurementMode = null;
        let measurementLine = null;
        let measurementMarkers = [];
        let measuredDimensions = { width: 0, length: 0 };
        let geocoder;
        let currentCity = '';
        let mapSnapshot = null;

        // ローカルストレージからAPIキーを取得
        function getStoredApiKey() {
            return localStorage.getItem('googleMapsApiKey');
        }

        // APIキーを保存
        function saveApiKey() {
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            if (apiKey) {
                localStorage.setItem('googleMapsApiKey', apiKey);
                alert('APIキーを保存しました');
            }
        }

        // APIキーフォームを表示
        function showApiKeyForm() {
            document.getElementById('apiKeyOverlay').style.display = 'flex';
            const storedKey = getStoredApiKey();
            if (storedKey) {
                document.getElementById('apiKeyInput').value = storedKey;
            }
        }

        // APIキーで地図を読み込む
        function loadMapWithKey() {
            const apiKey = document.getElementById('apiKeyInput').value.trim() || getStoredApiKey();
            if (!apiKey) {
                alert('APIキーを入力してください');
                return;
            }

            // 既存のスクリプトタグを削除
            const existingScript = document.querySelector('script[src*="maps.googleapis.com"]');
            if (existingScript) {
                existingScript.remove();
            }

            // 新しいスクリプトタグを作成
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&callback=initMap&libraries=drawing,geometry,places`;
            script.async = true;
            script.defer = true;
            script.onerror = function() {
                alert('APIキーが無効か、Google Maps APIの読み込みに失敗しました。APIキーを確認してください。');
                showApiKeyForm();
            };
            document.head.appendChild(script);

            // オーバーレイを非表示
            document.getElementById('apiKeyOverlay').style.display = 'none';
        }

        // Google Maps初期化
        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 36.2048, lng: 138.2529 }, // 日本の中心付近
                zoom: 12,
                mapTypeId: 'satellite'
            });

            // Geocoder初期化
            geocoder = new google.maps.Geocoder();

            // 住所検索ボックスの初期化
            const searchBox = document.getElementById('searchBox');
            searchBox.style.display = 'block';
            const searchBoxControl = new google.maps.places.SearchBox(searchBox);
            
            // 検索ボックスを地図に配置
            map.controls[google.maps.ControlPosition.TOP_LEFT].push(searchBox);

            // 検索結果が選択されたときの処理
            searchBoxControl.addListener('places_changed', function() {
                const places = searchBoxControl.getPlaces();

                if (places.length === 0) {
                    return;
                }

                // 最初の検索結果に移動
                const place = places[0];
                if (!place.geometry || !place.geometry.location) {
                    alert('場所が見つかりませんでした');
                    return;
                }

                // 地図を移動
                if (place.geometry.viewport) {
                    map.fitBounds(place.geometry.viewport);
                } else {
                    map.setCenter(place.geometry.location);
                    map.setZoom(17);
                }

                // 市町村名を取得
                updateCityName(place.geometry.location);
            });

            // 地図の表示範囲が変更されたときに検索ボックスの検索範囲を更新
            map.addListener('bounds_changed', function() {
                searchBoxControl.setBounds(map.getBounds());
            });

            // 描画ツール
            drawingManager = new google.maps.drawing.DrawingManager({
                drawingMode: null,
                drawingControl: true,
                drawingControlOptions: {
                    position: google.maps.ControlPosition.TOP_CENTER,
                    drawingModes: ['polygon', 'rectangle']
                },
                polygonOptions: {
                    fillColor: '#00ff00',
                    fillOpacity: 0.3,
                    strokeWeight: 2,
                    strokeColor: '#00ff00',
                    editable: true,
                    draggable: true
                },
                rectangleOptions: {
                    fillColor: '#00ff00',
                    fillOpacity: 0.3,
                    strokeWeight: 2,
                    strokeColor: '#00ff00',
                    editable: true,
                    draggable: true
                }
            });
            drawingManager.setMap(map);

            // 図形完成時のイベント
            google.maps.event.addListener(drawingManager, 'overlaycomplete', function(event) {
                if (selectedPolygon) {
                    selectedPolygon.setMap(null);
                }
                selectedPolygon = event.overlay;
                drawingManager.setDrawingMode(null);

                calculateAreaAndDimensions();

                // 編集時の再計算
                if (event.type === 'polygon') {
                    google.maps.event.addListener(selectedPolygon.getPath(), 'set_at', calculateAreaAndDimensions);
                    google.maps.event.addListener(selectedPolygon.getPath(), 'insert_at', calculateAreaAndDimensions);
                } else if (event.type === 'rectangle') {
                    google.maps.event.addListener(selectedPolygon, 'bounds_changed', calculateAreaAndDimensions);
                }

                // 選択した場所の市町村名を取得
                const center = map.getCenter();
                updateCityName(center);
            });

            // カスタムコントロール
            const clearButton = document.createElement('div');
            clearButton.className = 'map-controls';
            clearButton.innerHTML = '<button class="controls-button" onclick="clearSelection()">選択をクリア</button>';
            map.controls[google.maps.ControlPosition.TOP_RIGHT].push(clearButton);

            // 測定ボタン
            const measureButton = document.createElement('div');
            measureButton.className = 'map-controls';
            measureButton.innerHTML = '<button class="controls-button" id="measureBtn" onclick="toggleMeasurement()">📏 測定開始</button>';
            map.controls[google.maps.ControlPosition.TOP_RIGHT].push(measureButton);

            // 現在地ボタン
            const locationButton = document.createElement('div');
            locationButton.className = 'map-controls';
            locationButton.innerHTML = '<button class="controls-button" onclick="getCurrentLocation()">📍 現在地</button>';
            map.controls[google.maps.ControlPosition.TOP_RIGHT].push(locationButton);

            // APIキー警告を非表示
            document.getElementById('apiKeyWarning').style.display = 'none';
        }

        // 市町村名を更新
        function updateCityName(location) {
            geocoder.geocode({ location: location }, (results, status) => {
                if (status === 'OK' && results[0]) {
                    for (let component of results[0].address_components) {
                        if (component.types.includes('locality')) {
                            currentCity = component.long_name;
                            break;
                        }
                    }
                }
            });
        }

        // 測定モードの切り替え
        function toggleMeasurement() {
            const btn = document.getElementById('measureBtn');
            if (measurementMode === null) {
                measurementMode = 'width';
                btn.textContent = '📏 幅を測定中...';
                btn.classList.add('measuring');
                alert('農地の幅（東西方向）を測定してください。2点をクリックして距離を測定します。');
                
                // マップクリックイベントを追加
                map.addListener('click', handleMeasurementClick);
            } else {
                endMeasurement();
            }
        }

        // 測定クリック処理
        function handleMeasurementClick(event) {
            if (measurementMarkers.length < 2) {
                const marker = new google.maps.Marker({
                    position: event.latLng,
                    map: map,
                    title: measurementMarkers.length === 0 ? '開始点' : '終了点'
                });
                measurementMarkers.push(marker);

                if (measurementMarkers.length === 2) {
                    // 距離を計算
                    const distance = google.maps.geometry.spherical.computeDistanceBetween(
                        measurementMarkers[0].getPosition(),
                        measurementMarkers[1].getPosition()
                    );

                    // ラインを描画
                    if (measurementLine) measurementLine.setMap(null);
                    measurementLine = new google.maps.Polyline({
                        path: [measurementMarkers[0].getPosition(), measurementMarkers[1].getPosition()],
                        geodesic: true,
                        strokeColor: '#FF0000',
                        strokeOpacity: 1.0,
                        strokeWeight: 3
                    });
                    measurementLine.setMap(map);

                    // 測定結果を保存
                    if (measurementMode === 'width') {
                        measuredDimensions.width = distance;
                        alert(`幅: ${distance.toFixed(1)}m\n次に長さ（南北方向）を測定してください。`);
                        
                        // 長さ測定モードへ
                        clearMeasurementMarkers();
                        measurementMode = 'length';
                        document.getElementById('measureBtn').textContent = '📏 長さを測定中...';
                    } else if (measurementMode === 'length') {
                        measuredDimensions.length = distance;
                        alert(`長さ: ${distance.toFixed(1)}m\n測定が完了しました。`);
                        
                        // 測定結果を表示
                        document.getElementById('measuredWidth').textContent = measuredDimensions.width.toFixed(1);
                        document.getElementById('measuredLength').textContent = measuredDimensions.length.toFixed(1);
                        document.getElementById('areaInfo').style.display = 'block';
                        
                        // 農地寸法を更新
                        updateFieldDimensions();
                        
                        // 測定終了
                        endMeasurement();
                    }
                }
            }
        }

        // 測定マーカーをクリア
        function clearMeasurementMarkers() {
            measurementMarkers.forEach(marker => marker.setMap(null));
            measurementMarkers = [];
            if (measurementLine) {
                measurementLine.setMap(null);
                measurementLine = null;
            }
        }

        // 測定終了
        function endMeasurement() {
            measurementMode = null;
            clearMeasurementMarkers();
            google.maps.event.clearListeners(map, 'click');
            const btn = document.getElementById('measureBtn');
            btn.textContent = '📏 測定開始';
            btn.classList.remove('measuring');
        }

        // 現在地を取得
        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const pos = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        map.setCenter(pos);
                        map.setZoom(17);
                        
                        // 現在地にマーカーを表示
                        new google.maps.Marker({
                            position: pos,
                            map: map,
                            title: '現在地',
                            icon: {
                                path: google.maps.SymbolPath.CIRCLE,
                                scale: 10,
                                fillColor: '#4285F4',
                                fillOpacity: 1,
                                strokeColor: '#ffffff',
                                strokeWeight: 2
                            }
                        });

                        // 市町村名を更新
                        updateCityName(pos);
                    },
                    () => {
                        alert('現在地の取得に失敗しました。位置情報の許可を確認してください。');
                    }
                );
            } else {
                alert('お使いのブラウザは位置情報をサポートしていません。');
            }
        }

        // 面積と寸法を計算
        function calculateAreaAndDimensions() {
            let area;
            
            if (selectedPolygon.getBounds) {
                // 長方形の場合
                const bounds = selectedPolygon.getBounds();
                const ne = bounds.getNorthEast();
                const sw = bounds.getSouthWest();
                const se = new google.maps.LatLng(sw.lat(), ne.lng());
                const nw = new google.maps.LatLng(ne.lat(), sw.lng());
                
                const width = google.maps.geometry.spherical.computeDistanceBetween(sw, se);
                const length = google.maps.geometry.spherical.computeDistanceBetween(sw, nw);
                area = width * length;
            } else {
                // 多角形の場合
                area = google.maps.geometry.spherical.computeArea(selectedPolygon.getPath());
            }

            // 表示更新
            document.getElementById('areaInfo').style.display = 'block';
            document.getElementById('selectedArea').textContent = Math.round(area).toLocaleString();
            
            // 注意：測定ツールを使用してください
            if (measuredDimensions.width === 0) {
                document.getElementById('measuredWidth').textContent = '未測定';
                document.getElementById('measuredLength').textContent = '未測定';
            }
        }

        // 離隔を考慮した農地寸法を更新
        function updateFieldDimensions() {
            const margin = parseFloat(document.getElementById('fieldMargin').value) || 0;
            
            if (measuredDimensions.width > 0 && measuredDimensions.length > 0) {
                // 測定値から離隔を考慮した寸法を計算
                const effectiveWidth = Math.max(0, measuredDimensions.width - (margin * 2));
                const effectiveLength = Math.max(0, measuredDimensions.length - (margin * 2));
                
                // 入力フィールドに反映
                document.getElementById('fieldWidth').value = Math.round(effectiveWidth);
                document.getElementById('fieldLength').value = Math.round(effectiveLength);
                
                // 自動計算
                calculate();
            }
        }

        // 選択クリア
        function clearSelection() {
            if (selectedPolygon) {
                selectedPolygon.setMap(null);
                selectedPolygon = null;
                document.getElementById('areaInfo').style.display = 'none';
                measuredDimensions = { width: 0, length: 0 };
            }
            endMeasurement();
        }

        // 配置イメージを描画
        function drawLayoutPreview() {
            const canvas = document.getElementById('layoutPreview');
            const fieldWidth = parseFloat(document.getElementById('fieldWidth').value) || 0;
            const fieldLength = parseFloat(document.getElementById('fieldLength').value) || 0;
            const panelWidth = parseFloat(document.getElementById('panelWidth').value) || 0;
            const panelHeight = parseFloat(document.getElementById('panelHeight').value) || 0;
            const columnSpacing = parseFloat(document.getElementById('columnSpacing').value) || 0;
            const rowSpacing = parseFloat(document.getElementById('rowSpacing').value) || 0;

            if (fieldWidth === 0 || fieldLength === 0) return;

            // キャンバスサイズを設定
            const scale = Math.min(800 / (fieldWidth * 1000), 280 / (fieldLength * 1000));
            canvas.style.width = '100%';
            canvas.style.height = '300px';

            // 既存のパネルをクリア
            canvas.innerHTML = '';

            // 農地の背景
            canvas.style.backgroundColor = '#e8f5e9';

            const columnCount = Math.floor((fieldWidth * 1000) / (panelWidth + columnSpacing));
            const rowCount = Math.floor((fieldLength * 1000) / (panelHeight + rowSpacing));

            // パネルを配置
            for (let row = 0; row < rowCount; row++) {
                for (let col = 0; col < columnCount; col++) {
                    const panel = document.createElement('div');
                    panel.className = 'panel-preview';
                    panel.style.width = (panelWidth * scale) + 'px';
                    panel.style.height = (panelHeight * scale) + 'px';
                    panel.style.left = (col * (panelWidth + columnSpacing) * scale) + 'px';
                    panel.style.top = (row * (panelHeight + rowSpacing) * scale) + 'px';
                    canvas.appendChild(panel);
                }
            }
        }

        // 計算実行
        function calculate() {
            // 入力値取得
            const fieldWidth = parseFloat(document.getElementById('fieldWidth').value) || 0;
            const fieldLength = parseFloat(document.getElementById('fieldLength').value) || 0;
            const panelWidth = parseFloat(document.getElementById('panelWidth').value) || 0;
            const panelHeight = parseFloat(document.getElementById('panelHeight').value) || 0;
            const tiltAngle = parseFloat(document.getElementById('tiltAngle').value) || 0;
            const columnSpacing = parseFloat(document.getElementById('columnSpacing').value) || 0;
            const rowSpacing = parseFloat(document.getElementById('rowSpacing').value) || 0;
            const panelCapacity = parseFloat(document.getElementById('panelCapacity').value) || 600;
            const fieldMargin = parseFloat(document.getElementById('fieldMargin').value) || 0;

            // 面積計算
            const totalFieldArea = fieldWidth * fieldLength;
            const singlePanelArea = (panelWidth * panelHeight) / 1000000; // mm² to m²
            const panelHorizontalProjection = singlePanelArea * Math.cos((tiltAngle * Math.PI) / 180);

            // 配置計算（修正：列=東西、段=南北）
            const columnCount = Math.floor((fieldWidth * 1000) / (panelWidth + columnSpacing));
            const rowCount = Math.floor((fieldLength * 1000) / (panelHeight + rowSpacing));
            const totalPanels = rowCount * columnCount;

            // パネル総面積
            const totalPanelArea = totalPanels * singlePanelArea;
            const totalPanelHorizontalArea = totalPanels * panelHorizontalProjection;

            // 有効農地面積（離隔を考慮）
            const effectiveArea = measuredDimensions.width * measuredDimensions.length;

            // 遮光率
            const shadingRatio = totalFieldArea > 0 ? (totalPanelHorizontalArea / totalFieldArea) * 100 : 0;

            // 推定発電量（カスタム容量を使用）
            const estimatedPower = (totalPanels * panelCapacity) / 1000; // W to kW

            // 作物適性
            let cropSuitability;
            if (shadingRatio < 20) {
                cropSuitability = '日照要求型作物（トマト、キュウリ、ナス、ピーマン等）';
            } else if (shadingRatio < 35) {
                cropSuitability = '半日陰適応型作物（レタス、ホウレンソウ、小松菜等）';
            } else if (shadingRatio < 50) {
                cropSuitability = '日陰適応型作物（ミョウガ、シイタケ、山菜等）';
            } else {
                cropSuitability = '畜産・牧草利用（牛、羊の放牧、飼料作物等）';
            }

            // 結果表示
            document.getElementById('columnCount').textContent = columnCount + ' 列';
            document.getElementById('rowCount').textContent = rowCount + ' 段';
            document.getElementById('totalPanels').textContent = totalPanels + ' 枚';
            document.getElementById('totalFieldArea').textContent = Math.round(totalFieldArea).toLocaleString() + ' m²';
            document.getElementById('totalPanelArea').textContent = Math.round(totalPanelArea).toLocaleString() + ' m²';
            document.getElementById('effectiveArea').textContent = Math.round(effectiveArea).toLocaleString() + ' m²';
            document.getElementById('shadingRatio').textContent = Math.round(shadingRatio * 10) / 10 + '%';
            document.getElementById('shadingBar').style.width = Math.min(shadingRatio, 100) + '%';
            document.getElementById('estimatedPower').textContent = Math.round(estimatedPower * 10) / 10 + ' kW';
            document.getElementById('panelCapacityInfo').textContent = `※パネル1枚${panelCapacity}W想定`;
            document.getElementById('cropSuitability').textContent = cropSuitability;

            // 遮光率に応じた色変更
            const shadingRatioElement = document.getElementById('shadingRatio');
            if (shadingRatio < 20) {
                shadingRatioElement.className = 'text-2xl font-bold text-green-600';
            } else if (shadingRatio < 35) {
                shadingRatioElement.className = 'text-2xl font-bold text-yellow-600';
            } else if (shadingRatio < 50) {
                shadingRatioElement.className = 'text-2xl font-bold text-orange-600';
            } else {
                shadingRatioElement.className = 'text-2xl font-bold text-red-600';
            }

            // 配置イメージを表示
            if (totalPanels > 0) {
                document.getElementById('layoutPreviewSection').style.display = 'block';
                drawLayoutPreview();
                document.getElementById('pdfButton').style.display = 'block';
                
                // 地図のスナップショットを取得
                if (map) {
                    html2canvas(document.getElementById('map'), {
                        useCORS: true,
                        allowTaint: false,
                        scale: 2
                    }).then(canvas => {
                        mapSnapshot = canvas;
                    });
                }
            }
        }

        // PDF生成関数
        async function generatePDF() {
            const { jsPDF } = window.jspdf;
            
            // A3横向きで作成
            const doc = new jsPDF({
                orientation: 'landscape',
                unit: 'mm',
                format: 'a3'
            });

            // 日本語フォントの設定（簡易的な対応）
            doc.setFont('helvetica');

            // 設定値を取得
            const fieldWidth = parseFloat(document.getElementById('fieldWidth').value) || 0;
            const fieldLength = parseFloat(document.getElementById('fieldLength').value) || 0;
            const panelWidth = parseFloat(document.getElementById('panelWidth').value) || 0;
            const panelHeight = parseFloat(document.getElementById('panelHeight').value) || 0;
            const tiltAngle = parseFloat(document.getElementById('tiltAngle').value) || 0;
            const columnSpacing = parseFloat(document.getElementById('columnSpacing').value) || 0;
            const rowSpacing = parseFloat(document.getElementById('rowSpacing').value) || 0;
            const panelCapacity = parseFloat(document.getElementById('panelCapacity').value) || 600;
            const columnCount = Math.floor((fieldWidth * 1000) / (panelWidth + columnSpacing));
            const rowCount = Math.floor((fieldLength * 1000) / (panelHeight + rowSpacing));
            const totalPanels = rowCount * columnCount;

            // 遮光率計算
            const singlePanelArea = (panelWidth * panelHeight) / 1000000;
            const panelHorizontalProjection = singlePanelArea * Math.cos((tiltAngle * Math.PI) / 180);
            const totalPanelHorizontalArea = totalPanels * panelHorizontalProjection;
            const totalFieldArea = fieldWidth * fieldLength;
            const shadingRatio = (totalPanelHorizontalArea / totalFieldArea) * 100;
            const totalPower = (totalPanels * panelCapacity) / 1000;

            // 図面枠を描画
            doc.setLineWidth(0.5);
            doc.rect(5, 5, 410, 287);
            doc.setLineWidth(1);
            doc.rect(10, 10, 400, 277);

            // タイトル（UTF-8対応のため英語併記）
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(18);
            const titleText = `Agrivoltaic System Layout ${totalPower.toFixed(1)}kW Shading Ratio ${shadingRatio.toFixed(1)}%`;
            doc.text(titleText, 210, 25, { align: 'center' });
            
            // 日本語タイトル（簡易表記）
            doc.setFontSize(14);
            doc.text(`[農地太陽光発電配置図]`, 210, 32, { align: 'center' });

            // Google Map背景（もし取得できていれば）
            if (mapSnapshot) {
                try {
                    const imgData = mapSnapshot.toDataURL('image/jpeg', 0.5);
                    doc.addImage(imgData, 'JPEG', 20, 40, 200, 150, undefined, 'FAST');
                    doc.setDrawColor(0);
                    doc.setLineWidth(0.5);
                    doc.rect(20, 40, 200, 150);
                } catch (e) {
                    console.error('Map image error:', e);
                }
            }

            // 平面図エリア（透明度を持つ白い背景）
            const planX = 20;
            const planY = 40;
            const planWidth = 200;
            const planHeight = 150;
            
            // 平面図の枠
            doc.setLineWidth(0.5);
            doc.setDrawColor(0);
            doc.rect(planX, planY, planWidth, planHeight);

            // スケール計算
            const scaleX = (planWidth - 20) / (fieldWidth * 1000);
            const scaleY = (planHeight - 20) / (fieldLength * 1000);
            const scale = Math.min(scaleX, scaleY);

            // 農地外形
            const scaledFieldWidth = fieldWidth * 1000 * scale;
            const scaledFieldLength = fieldLength * 1000 * scale;
            const offsetX = planX + (planWidth - scaledFieldWidth) / 2;
            const offsetY = planY + (planHeight - scaledFieldLength) / 2;

            doc.setLineWidth(2);
            doc.setDrawColor(255, 0, 0);
            doc.rect(offsetX, offsetY, scaledFieldWidth, scaledFieldLength);

            // パネル配置を描画
            doc.setLineWidth(0.3);
            doc.setFillColor(200, 200, 255);
            doc.setDrawColor(100, 100, 255);
            for (let row = 0; row < rowCount; row++) {
                for (let col = 0; col < columnCount; col++) {
                    const x = offsetX + col * (panelWidth + columnSpacing) * scale;
                    const y = offsetY + row * (panelHeight + rowSpacing) * scale;
                    const w = panelWidth * scale;
                    const h = panelHeight * scale;
                    doc.rect(x, y, w, h, 'FD');
                }
            }

            // 寸法線と数値
            doc.setDrawColor(0);
            doc.setLineWidth(0.5);
            
            // 横寸法（農地幅）
            doc.line(offsetX, offsetY - 5, offsetX + scaledFieldWidth, offsetY - 5);
            doc.line(offsetX, offsetY - 7, offsetX, offsetY - 3);
            doc.line(offsetX + scaledFieldWidth, offsetY - 7, offsetX + scaledFieldWidth, offsetY - 3);
            doc.setFontSize(10);
            doc.text(`${fieldWidth}m`, offsetX + scaledFieldWidth / 2, offsetY - 8, { align: 'center' });

            // 縦寸法（農地長さ）
            doc.line(offsetX - 5, offsetY, offsetX - 5, offsetY + scaledFieldLength);
            doc.line(offsetX - 7, offsetY, offsetX - 3, offsetY);
            doc.line(offsetX - 7, offsetY + scaledFieldLength, offsetX - 3, offsetY + scaledFieldLength);
            doc.save();
            doc.text(`${fieldLength}m`, offsetX - 10, offsetY + scaledFieldLength / 2, { angle: 90 });
            doc.restore();

            // パネル間隔の表示
            if (columnCount > 1) {
                const spacing1X = offsetX + panelWidth * scale;
                const spacing1Y = offsetY + scaledFieldLength + 15;
                doc.setLineWidth(0.3);
                doc.line(spacing1X, spacing1Y, spacing1X + columnSpacing * scale, spacing1Y);
                doc.setFontSize(8);
                doc.text(`${columnSpacing}mm`, spacing1X + (columnSpacing * scale) / 2, spacing1Y - 2, { align: 'center' });
            }

            if (rowCount > 1) {
                const spacing2X = offsetX + scaledFieldWidth + 15;
                const spacing2Y = offsetY + panelHeight * scale;
                doc.setLineWidth(0.3);
                doc.line(spacing2X, spacing2Y, spacing2X, spacing2Y + rowSpacing * scale);
                doc.setFontSize(8);
                doc.save();
                doc.text(`${rowSpacing}mm`, spacing2X + 2, spacing2Y + (rowSpacing * scale) / 2, { angle: 90 });
                doc.restore();
            }

            // 方位記号（改善版）
            const compassX = 195;
            const compassY = 165;
            doc.setLineWidth(0.5);
            doc.setDrawColor(0);
            doc.circle(compassX, compassY, 10);
            doc.setLineWidth(2);
            // 北向き矢印
            doc.line(compassX, compassY - 8, compassX, compassY + 8);
            doc.line(compassX, compassY - 8, compassX - 3, compassY - 3);
            doc.line(compassX, compassY - 8, compassX + 3, compassY - 3);
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text('N', compassX, compassY - 12, { align: 'center' });
            // 東西南の表示
            doc.setFontSize(8);
            doc.text('E', compassX + 12, compassY + 1, { align: 'center' });
            doc.text('W', compassX - 12, compassY + 1, { align: 'center' });
            doc.text('S', compassX, compassY + 14, { align: 'center' });

            // システム構成ボックス（右側）
            const sysX = 230;
            const sysY = 40;
            doc.setLineWidth(0.5);
            doc.rect(sysX, sysY, 170, 80);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(12);
            doc.text('System Configuration', sysX + 5, sysY + 10);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            
            const sysInfo = [
                `Module Capacity: ${panelCapacity}W`,
                `Panel Size: ${panelWidth} x ${panelHeight}mm`,
                `Tilt Angle: ${tiltAngle} degrees`,
                `Number of Panels: ${totalPanels}`,
                `Total Capacity: ${totalPower.toFixed(1)}kW`,
                `Panel Area: ${singlePanelArea.toFixed(3)}m2/panel`,
                `Layout: ${columnCount} columns x ${rowCount} rows`
            ];
            
            sysInfo.forEach((info, index) => {
                doc.text(info, sysX + 5, sysY + 20 + (index * 8));
            });

            // 遮光率計算ボックス（下部）
            const calcX = 20;
            const calcY = 200;
            doc.setLineWidth(0.5);
            doc.rect(calcX, calcY, 380, 50);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(12);
            doc.text('Shading Ratio Calculation', calcX + 5, calcY + 10);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            
            const calcInfo = [
                `Total Module Area: ${totalPanels} panels x ${singlePanelArea.toFixed(4)}m2 = ${(totalPanels * singlePanelArea).toFixed(2)}m2`,
                `Horizontal Projection Area: ${(totalPanels * panelHorizontalProjection).toFixed(2)}m2 (considering ${tiltAngle} degree tilt)`,
                `Field Area: ${totalFieldArea.toFixed(1)}m2`,
                `Formula: Shading Ratio = ${(totalPanels * panelHorizontalProjection).toFixed(2)}m2 / ${totalFieldArea.toFixed(1)}m2 x 100 = ${shadingRatio.toFixed(2)}%`
            ];
            
            calcInfo.forEach((info, index) => {
                doc.text(info, calcX + 5, calcY + 20 + (index * 8));
            });
            
            // 遮光率を赤字で強調
            doc.setTextColor(255, 0, 0);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(14);
            doc.text(`Shading Ratio = ${shadingRatio.toFixed(2)}%`, calcX + 300, calcY + 44);
            doc.setTextColor(0, 0, 0);

            // 表題欄
            doc.setLineWidth(0.5);
            doc.rect(20, 255, 380, 25);
            doc.line(100, 255, 100, 280);
            doc.line(180, 255, 180, 280);
            doc.line(260, 255, 260, 280);
            doc.line(340, 255, 340, 280);
            
            doc.setFontSize(9);
            doc.text('Project Name', 60, 262, { align: 'center' });
            doc.text('Designer', 140, 262, { align: 'center' });
            doc.text('Date', 220, 262, { align: 'center' });
            doc.text('Location', 300, 262, { align: 'center' });
            doc.text('Drawing No.', 370, 262, { align: 'center' });
            
            // 記入内容
            doc.setFontSize(10);
            doc.text('Agrivoltaic System', 60, 272, { align: 'center' });
            doc.text('SPRITE Co., Ltd.', 140, 269, { align: 'center' });
            doc.text('Hara', 140, 275, { align: 'center' });
            
            // 日付
            const today = new Date();
            const year = today.getFullYear().toString().slice(2);
            const month = ('0' + (today.getMonth() + 1)).slice(-2);
            const day = ('0' + today.getDate()).slice(-2);
            const dateStr = `${year}/${month}/${day}`;
            doc.text(dateStr, 220, 272, { align: 'center' });
            
            // 場所（市町村名）
            doc.text(currentCity || 'Unknown', 300, 272, { align: 'center' });
            
            // 図面番号
            doc.text('001', 370, 272, { align: 'center' });

            // ファイル名を生成
            const filename = `${year}${month}${day}${currentCity || 'unknown'}${totalPower.toFixed(1)}kw${shadingRatio.toFixed(1)}%.pdf`;
            
            // PDFを保存
            doc.save(filename);
        }

        // ページ読み込み時の処理
        document.addEventListener('DOMContentLoaded', function() {
            // 入力変更時の自動計算
            const inputs = document.querySelectorAll('input[type="number"]');
            inputs.forEach(input => {
                input.addEventListener('input', calculate);
            });
            calculate();

            // 保存されたAPIキーがあるか確認
            const storedApiKey = getStoredApiKey();
            if (storedApiKey) {
                // 自動的に地図を読み込む
                document.getElementById('apiKeyInput').value = storedApiKey;
                loadMapWithKey();
            } else {
                // APIキー入力フォームを表示
                document.getElementById('apiKeyWarning').style.display = 'block';
            }
        });
    </script>
</body>
</html>
